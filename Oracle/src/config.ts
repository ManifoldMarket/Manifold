import dotenv from "dotenv";

dotenv.config();

export const ORACLE_PRIVATE_KEY = process.env.ORACLE_PRIVATE_KEY || "";
export const ALEO_NODE_URL = process.env.ALEO_NODE_URL || "";
export const ETHERSCAN_API_KEY = process.env.ETHERSCAN_API_KEY || "";

// PostgreSQL Configuration
const useSSL = process.env.PGSSL === "true" || !!process.env.DATABASE_URL?.includes("sslmode=require");

export const DB_CONFIG = {
    connectionString: process.env.DATABASE_URL || undefined,
    host: process.env.PGHOST || "localhost",
    port: parseInt(process.env.PGPORT || "5432"),
    user: process.env.PGUSER || "postgres",
    password: process.env.PGPASSWORD || "",
    database: process.env.PGDATABASE || "oracle_db",
    ssl: useSSL ? { rejectUnauthorized: false } : false,
};

export const PROGRAM_ID = "predictionprivacyhackviii.aleo";
export const ALEO_BROADCAST_URL = `${ALEO_NODE_URL}/testnet/transaction/broadcast`;

// Costs
export const CREATE_POOL_FEE = 2_000_000;
export const LOCK_POOL_FEE = 500_000;
export const RESOLVE_POOL_FEE = 1_000_000;

// Embedded Program Source (Mock)
export const PROGRAM_SOURCE = `program predictionprivacyhackviii.aleo;\n\nrecord credits:\n    owner as address.private;\n    microcredits as u64.private;\n\nrecord Prediction:\n    owner as address.private;\n    id as field.private;\n    pool_id as field.private;\n    option as u64.private;\n    amount as u64.private;\n    claimed as boolean.private;\n\nstruct Pool:\n    id as field;\n    title as field;\n    description as field;\n    options as [field; 2u32];\n    deadline as u64;\n    status as u8;\n    winning_option as u64;\n    total_staked as u64;\n    option_a_stakes as u64;\n    option_b_stakes as u64;\n    total_no_of_stakes as u64;\n    total_no_of_stakes_option_a as u64;\n    total_no_of_stakes_option_b as u64;\n\nstruct Default:\n    id as u32;\n\nmapping pools:\n    key as field.public;\n    value as Pool.public;\n\nmapping total_predictions:\n    key as field.public;\n    value as u64.public;\n\nmapping pools_id__:\n    key as u32.public;\n    value as field.public;\n\nmapping pools_id__len__:\n    key as boolean.public;\n    value as u32.public;\n\nmapping user_predictions__:\n    key as u32.public;\n    value as field.public;\n\nmapping user_predictions__len__:\n    key as boolean.public;\n    value as u32.public;\n\nfunction initialize:\n    async initialize self.caller into r0;\n    output r0 as predictionprivacyhackviii.aleo/initialize.future;\n\nfinalize initialize:\n    input r0 as address.public;\n    assert.eq true true;\n\nfunction main:\n\nfunction create_pool:\n    input r0 as field.public;\n    input r1 as field.public;\n    input r2 as [field; 2u32].public;\n    input r3 as u64.public;\n    hash.bhp256 r0 into r4 as field;\n    assert.eq self.caller aleo1jl3q3uywtdzlr8dln65xjc2mr7vwa2pm9fsenq49zsgsz5a8pqzs0j7cj5;\n    cast r4 r0 r1 r2 r3 0u8 0u64 0u64 0u64 0u64 0u64 0u64 0u64 into r5 as Pool;\n    async create_pool r4 r5 into r6;\n    output r5 as Pool.private;\n    output r6 as predictionprivacyhackviii.aleo/create_pool.future;\n\nfinalize create_pool:\n    input r0 as field.public;\n    input r1 as Pool.public;\n    set 0u64 into total_predictions[r0];\n    set r1 into pools[r0];\n    get.or_use pools_id__len__[false] 0u32 into r2;\n    add r2 1u32 into r3;\n    set r3 into pools_id__len__[false];\n    set r0 into pools_id__[r2];\n\nfunction lock_pool:\n    input r0 as field.public;\n    assert.eq self.caller aleo1jl3q3uywtdzlr8dln65xjc2mr7vwa2pm9fsenq49zsgsz5a8pqzs0j7cj5;\n    async lock_pool r0 into r1;\n    output r1 as predictionprivacyhackviii.aleo/lock_pool.future;\n\nfinalize lock_pool:\n    input r0 as field.public;\n    get pools[r0] into r1;\n    cast r1.id r1.title r1.description r1.options r1.deadline 1u8 r1.winning_option r1.total_staked r1.option_a_stakes r1.option_b_stakes r1.total_no_of_stakes r1.total_no_of_stakes_option_a r1.total_no_of_stakes_option_b into r2 as Pool;\n    set r2 into pools[r0];\n\nfunction resolve_pool:\n    input r0 as field.public;\n    input r1 as u64.public;\n    assert.eq self.caller aleo1jl3q3uywtdzlr8dln65xjc2mr7vwa2pm9fsenq49zsgsz5a8pqzs0j7cj5;\n    async resolve_pool r0 r1 into r2;\n    output r2 as predictionprivacyhackviii.aleo/resolve_pool.future;\n\nfinalize resolve_pool:\n    input r0 as field.public;\n    input r1 as u64.public;\n    get pools[r0] into r2;\n    cast r2.id r2.title r2.description r2.options r2.deadline 2u8 r1 r2.total_staked r2.option_a_stakes r2.option_b_stakes r2.total_no_of_stakes r2.total_no_of_stakes_option_a r2.total_no_of_stakes_option_b into r3 as Pool;\n    set r3 into pools[r0];\n\nfunction predict:\n    input r0 as field.private;\n    input r1 as u64.private;\n    input r2 as u64.private;\n    input r3 as u64.private;\n    input r4 as credits.record;\n    is.eq r1 1u64 into r5;\n    is.eq r1 2u64 into r6;\n    or r5 r6 into r7;\n    assert.eq r7 true;\n    assert.neq r2 0u64;\n    hash.bhp256 r3 into r8 as field;\n    cast self.caller r8 r0 r1 r2 false into r9 as Prediction.record;\n    ternary r5 r2 0u64 into r10;\n    ternary r5 0u64 r2 into r11;\n    sub r4.microcredits r2 into r12;\n    cast r4.owner r12 into r13 as credits.record;\n    cast aleo1jl3q3uywtdzlr8dln65xjc2mr7vwa2pm9fsenq49zsgsz5a8pqzs0j7cj5 r4.microcredits into r14 as credits.record;\n    async predict r0 r8 r2 r1 r10 r11 into r15;\n    output r9 as Prediction.record;\n    output r13 as credits.record;\n    output r14 as credits.record;\n    output r15 as predictionprivacyhackviii.aleo/predict.future;\n\nfinalize predict:\n    input r0 as field.public;\n    input r1 as field.public;\n    input r2 as u64.public;\n    input r3 as u64.public;\n    input r4 as u64.public;\n    input r5 as u64.public;\n    contains pools[r0] into r6;\n    assert.eq r6 true;\n    get pools[r0] into r7;\n    assert.eq r7.status 0u8;\n    cast block.timestamp into r8 as u64;\n    gt r7.deadline r8 into r9;\n    assert.eq r9 true;\n    add r7.total_staked r2 into r10;\n    add r7.option_a_stakes r4 into r11;\n    add r7.option_b_stakes r5 into r12;\n    cast r7.id r7.title r7.description r7.options r7.deadline r7.status r7.winning_option r10 r11 r12 r7.total_no_of_stakes r7.total_no_of_stakes_option_a r7.total_no_of_stakes_option_b into r13 as Pool;\n    set r13 into pools[r0];\n    get total_predictions[r0] into r14;\n    add r14 1u64 into r15;\n    set r15 into total_predictions[r0];\n\nfunction check_prediction:\n    input r0 as Prediction.record;\n    async check_prediction r0.pool_id r0.option into r1;\n    output r1 as predictionprivacyhackviii.aleo/check_prediction.future;\n\nfinalize check_prediction:\n    input r0 as field.public;\n    input r1 as u64.public;\n    contains pools[r0] into r2;\n    assert.eq r2 true;\n    get pools[r0] into r3;\n    assert.eq r3.status 2u8;\n    assert.eq r3.winning_option r1;\n\nclosure calculate_winnings:\n    input r0 as u64;\n    input r1 as u64;\n    input r2 as u64;\n    is.eq r2 0u64 into r3;\n    mul r0 r1 into r4;\n    div r4 r2 into r5;\n    ternary r3 0u64 r5 into r6;\n    output r6 as u64;\n\nfunction collect_winnings:\n    input r0 as u64.private;\n    input r1 as u64.private;\n    input r2 as u64.private;\n    input r3 as u64.private;\n    input r4 as credits.record;\n    input r5 as Prediction.record;\n    assert.eq r0 r5.option;\n    assert.eq r5.claimed false;\n    is.eq r0 1u64 into r6;\n    gt r2 0u64 into r7;\n    not r6 into r8;\n    or r7 r8 into r9;\n    assert.eq r9 true;\n    call calculate_winnings r5.amount r1 r2 into r10;\n    is.eq r0 2u64 into r11;\n    gt r3 0u64 into r12;\n    and r8 r11 into r13;\n    not r13 into r14;\n    or r12 r14 into r15;\n    assert.eq r15 true;\n    add r2 r3 into r16;\n    call calculate_winnings r5.amount r1 r16 into r17;\n    ternary r11 r17 0u64 into r18;\n    ternary r6 r10 r18 into r19;\n    cast r5.owner r5.id r5.pool_id r5.option r19 true into r20 as Prediction.record;\n    sub r4.microcredits r19 into r21;\n    cast r4.owner r21 into r22 as credits.record;\n    cast r5.owner r19 into r23 as credits.record;\n    async collect_winnings r5.pool_id r5.id r5.amount r0 r1 r2 r3 into r24;\n    output r20 as Prediction.record;\n    output r22 as credits.record;\n    output r23 as credits.record;\n    output r24 as predictionprivacyhackviii.aleo/collect_winnings.future;\n\nfinalize collect_winnings:\n    input r0 as field.public;\n    input r1 as field.public;\n    input r2 as u64.public;\n    input r3 as u64.public;\n    input r4 as u64.public;\n    input r5 as u64.public;\n    input r6 as u64.public;\n    contains pools[r0] into r7;\n    assert.eq r7 true;\n    get pools[r0] into r8;\n    assert.eq r8.status 2u8;\n    assert.eq r8.winning_option r3;\n    assert.eq r8.total_staked r4;\n    assert.eq r8.option_a_stakes r5;\n    assert.eq r8.option_b_stakes r6;\n\nconstructor:\n    assert.eq program_owner aleo1jl3q3uywtdzlr8dln65xjc2mr7vwa2pm9fsenq49zsgsz5a8pqzs0j7cj5;\n`;
